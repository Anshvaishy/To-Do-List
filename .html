<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Attendance — Local (No Firebase)</title>

  <!-- Fonts / icons / Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* New, enhanced color palette */
    :root { 
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #6b7280;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --muted: #e5e7eb; 
    }
    
    body, html {
      margin:0;
      padding:0;
      font-family:'Poppins',sans-serif;
      background:#f0f2f5;
      color:#222;
      overflow-x: hidden;
    }
    
    /* Login Page - New Animated Background */
    .login-page-bg {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: #0c0a0c;
      overflow: hidden;
    }
    .login-page-bg::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, #4f46e5, #9333ea, #db2777, #f59e0b);
        background-size: 400% 400%;
        animation: gradient-anim 15s ease infinite;
        opacity: 0.7;
    }

    /* Keyframes for the moving gradient background */
    @keyframes gradient-anim {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .login-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2.5rem;
      max-width: 420px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.18);
      position: relative;
      z-index: 10;
      animation: glow 3s ease-in-out infinite alternate; /* New glow animation */
    }

    /* Keyframes for the glowing effect on the card */
    @keyframes glow {
        from { box-shadow: 0 0 10px #4f46e5, 0 0 20px #9333ea, 0 0 30px #db2777; }
        to { box-shadow: 0 0 20px #4f46e5, 0 0 40px #9333ea, 0 0 60px #db2777; }
    }
    
    /* General Styles */
    .form-input{
      width:100%;
      padding:.75rem 1rem;
      border:2px solid var(--muted);
      border-radius:10px;
      transition:border-color .2s, box-shadow .3s;
    }
    .form-input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
      outline:none;
    }
    
    .login-btn{
      background:var(--primary);
      color:#fff;
      padding:.75rem 1rem;
      border-radius:10px;
      transition:background-color .2s, transform .2s;
    }
    .login-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .dashboard-container{
      display:flex;
      min-height:100vh
    }
    
    /* Sidebar */
    .sidebar{
      width:250px;
      background:#fff;
      padding:1.25rem;
      box-shadow:2px 0 10px rgba(0,0,0,.06);
      position:fixed;
      height:100%;
      overflow:auto;
    }
    
    .sidebar .nav-item{
      display:flex;
      align-items:center;
      padding:.75rem 1rem;
      border-radius:10px;
      color:#334155;
      margin-bottom:.5rem;
      text-decoration:none;
      transition:background-color .2s, color .2s;
    }
    
    .sidebar .nav-item.active{
      background: var(--primary);
      color: #fff;
    }
    
    .sidebar .nav-item:hover:not(.active) {
      background: var(--muted);
      color: var(--primary-dark);
    }

    .main-content{
      margin-left:270px;
      padding:1.5rem;
      flex:1
    }
    
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      margin-bottom:1.25rem
    }

    /* New Notice Circular Styles */
    #notice-circular {
      background: var(--warning);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 500;
    }
    #notice-circular .text {
      animation: marquee 20s linear infinite;
    }
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    
    .card{
      background:#fff;
      padding:1.5rem;
      border-radius:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.04);
      transition: transform 0.3s ease;
    }
    .card:hover {
        transform: translateY(-5px); /* Subtle hover effect */
    }
    
    /* Tables */
    .data-table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:12px;
      overflow:hidden
    }
    
    .data-table th,.data-table td{
      padding:12px;
      border-bottom:1px solid #f1f5f9;
      text-align:left
    }
    
    .actions-cell{
      white-space:nowrap
    }
    
    /* Modals & Toasts */
    .modal{
      display:none;
      position:fixed;
      z-index:1200;
      inset:0;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.35);
      animation: fadeIn 0.3s ease-out;
    }
    .modal.active{
      display:flex
    }
    .modal-content{
      background:#fff;
      padding:1.25rem;
      border-radius:12px;
      width:95%;
      max-width:560px;
      box-shadow:0 10px 25px rgba(0,0,0,.15);
      animation: slideIn 0.4s ease-out;
    }
    .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        line-height: 1;
        cursor: pointer;
    }
    
    .toast{
      position:fixed;
      right:20px;
      bottom:20px;
      background:#111;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      display:none;
      z-index:1300
    }
    .toast.show{
      display:block;
      animation:fade .3s
    }
    
    @keyframes fade{
      from{opacity:0}
      to{opacity:1}
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .hide{
      display:none!important
    }
    
    @media (max-width:900px){
      .sidebar{display:none}
      .main-content{margin-left:0;padding:1rem}
      .topbar{flex-wrap:wrap;gap:.75rem}
    }
    
    /* Button Utilities */
    .btn { 
      padding: .65rem 1.25rem; 
      border-radius:8px; 
      cursor:pointer; 
      border:none; 
      transition: background-color .2s, color .2s, transform .2s, box-shadow .2s;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
    }
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,.1);
    }
    .btn-primary { 
      background:var(--primary); 
      color:#fff; 
    }
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    .btn-secondary { 
      background:var(--muted); 
      color:#333; 
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }
    .btn-sm {
        padding: 0.35rem 0.75rem;
        font-size: 0.875rem;
    }
    .btn-danger {
        background: var(--danger);
        color: #fff;
    }
    .btn-danger:hover {
        background: #c22f2f;
    }

    /* Status Badges */
    .status-present { background-color: var(--success); color: white; padding: 4px 8px; border-radius: 6px; }
    .status-absent { background-color: var(--danger); color: white; padding: 4px 8px; border-radius: 6px; }
    
  </style>
</head>
<body>

  <!-- LOGIN -->
  <main id="login-page" class="login-page-bg p-4">
    <div class="login-card">
      <h1 class="text-3xl font-bold text-gray-100 mb-2">Smart Attendance</h1>
      <p class="text-sm text-gray-300 mb-6">Local offline demo — admin / admin123</p>
      <form id="login-form" class="space-y-4">
        <input id="username" class="form-input" placeholder="Username" autocomplete="username" required />
        <input id="password" class="form-input" placeholder="Password" type="password" autocomplete="current-password" required />
        <button type="submit" class="login-btn w-full mt-2 font-semibold">Sign In</button>
      </form>
      <p class="text-xs text-gray-400 mt-3">Demo user: <strong>admin / admin123</strong></p>
    </div>
  </main>

  <!-- DASHBOARD -->
  <div id="dashboard-main" class="dashboard-container" style="display:none;">
    <aside id="sidebar" class="sidebar" aria-label="Main navigation">
      <div class="mb-4 flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center">
            <i class="fas fa-check-circle text-white text-lg"></i>
        </div>
        <div>
          <h3 class="font-semibold text-lg">Smart Attendance</h3>
          <p class="text-xs text-gray-500">Local demo</p>
        </div>
      </div>

      <nav>
        <a href="#dashboard" class="nav-item active" data-section="dashboard"><i class="fas fa-home w-5"></i><span class="ml-2">Dashboard</span></a>
        <a href="#students" class="nav-item" data-section="students"><i class="fas fa-user-graduate w-5"></i><span class="ml-2">Students</span></a>
        <a href="#faculty" class="nav-item" data-section="faculty"><i class="fas fa-chalkboard-teacher w-5"></i><span class="ml-2">Faculty</span></a>
        <a href="#subjects" class="nav-item" data-section="subjects"><i class="fas fa-book w-5"></i><span class="ml-2">Subjects</span></a>
        <a href="#attendance" class="nav-item" data-section="attendance"><i class="fas fa-check-circle w-5"></i><span class="ml-2">Attendance</span></a>
        <a href="#marks" class="nav-item" data-section="marks"><i class="fas fa-clipboard-list w-5"></i><span class="ml-2">Marks</span></a>
        <a href="#grades" class="nav-item" data-section="grades"><i class="fas fa-award w-5"></i><span class="ml-2">Grades</span></a>
        <a href="#reports" class="nav-item" data-section="reports"><i class="fas fa-chart-bar w-5"></i><span class="ml-2">Reports</span></a>
        <a href="#notices" class="nav-item" data-section="notices"><i class="fas fa-bullhorn w-5"></i><span class="ml-2">Notices</span></a>
        <a href="#settings" class="nav-item" data-section="settings"><i class="fas fa-cogs w-5"></i><span class="ml-2">Settings</span></a>
        <a href="#" id="logout-btn" class="nav-item mt-4"><i class="fas fa-sign-out-alt w-5"></i><span class="ml-2">Log Out</span></a>
      </nav>

      <hr class="my-3"/>
      <div id="role-badge" class="text-xs text-gray-600"></div>
    </aside>

    <main id="main-content" class="main-content">
      <header class="topbar">
        <!-- नया सर्कुलर नोटिस बार यहां जोड़ा गया है -->
        <div id="notice-circular" class="hidden">
            <i class="fas fa-bullhorn text-white"></i>
            <marquee class="text" scrollamount="5"></marquee>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <button id="sidebar-toggle" class="p-2 rounded bg-gray-100 hover:bg-gray-200 transition-colors"><i class="fas fa-bars"></i></button>
          <div class="flex-grow">
            <input id="global-search" placeholder="Search..." class="form-input" />
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="user-display" class="flex items-center gap-2">
            <img src="https://placehold.co/40x40/4f46e5/ffffff?text=UN" alt="avatar" style="width:40px;height:40px;border-radius:50%"/>
            <div>
              <div id="user-display-name" class="text-sm font-semibold">User</div>
              <div id="user-display-role" class="text-xs text-gray-500">Role</div>
            </div>
          </div>
        </div>
      </header>

      <!-- Sections -->
      <section id="dashboard" class="content-section">
        <h2 class="text-2xl font-bold mb-3">Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="card">
            <h3 class="font-semibold text-gray-500">Total Students</h3>
            <p id="total-students" class="text-4xl font-bold mt-2 text-primary">0</p>
            <div class="mt-3"><button class="btn btn-secondary btn-sm export-csv" data-type="students">Export CSV</button></div>
          </div>
          <div class="card">
            <h3 class="font-semibold text-gray-500">Total Faculty</h3>
            <p id="total-faculty" class="text-4xl font-bold mt-2 text-primary">0</p>
            <div class="mt-3"><button class="btn btn-secondary btn-sm export-csv" data-type="faculty">Export CSV</button></div>
          </div>
          <div class="card">
            <h3 class="font-semibold text-gray-500">Total Subjects</h3>
            <p id="total-subjects" class="text-4xl font-bold mt-2 text-primary">0</p>
            <div class="mt-3"><button class="btn btn-secondary btn-sm export-csv" data-type="subjects">Export CSV</button></div>
          </div>
        </div>
      </section>

      <section id="students" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Students</h2>
          <div class="flex items-center gap-2">
            <button class="btn btn-secondary btn-sm export-csv" data-type="students">CSV</button>
            <button id="add-student-btn" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Add Student</button>
          </div>
        </div>
        <div class="card">
          <table class="data-table w-full">
            <thead><tr><th>Roll</th><th>Name</th><th>Class</th><th class="actions-cell">Actions</th></tr></thead>
            <tbody id="student-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="faculty" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Faculty</h2>
          <div class="flex items-center gap-2">
            <button class="btn btn-secondary btn-sm export-csv" data-type="faculty">CSV</button>
            <button id="add-faculty-btn" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Add Faculty</button>
          </div>
        </div>
        <div class="card">
          <table class="data-table w-full">
            <thead><tr><th>ID</th><th>Name</th><th>Dept</th><th class="actions-cell">Actions</th></tr></thead>
            <tbody id="faculty-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="subjects" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Subjects</h2>
          <div class="flex items-center gap-2">
            <button class="btn btn-secondary btn-sm export-csv" data-type="subjects">CSV</button>
            <button id="add-subject-btn" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Add Subject</button>
          </div>
        </div>
        <div class="card">
          <table class="data-table w-full">
            <thead><tr><th>Code</th><th>Name</th><th>Faculty</th><th class="actions-cell">Actions</th></tr></thead>
            <tbody id="subject-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="attendance" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Attendance</h2>
          <div class="flex items-center gap-2">
            <button class="btn btn-secondary btn-sm export-csv" data-type="attendance">CSV</button>
            <button id="take-attendance-btn" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Take Attendance</button>
            <button id="view-attendance-btn" class="btn btn-secondary btn-sm">View Records</button>
          </div>
        </div>

        <div id="attendance-table-container" class="card hide">
          <table class="data-table w-full">
            <thead><tr><th>Student</th><th>Subject</th><th>Date</th><th>Status</th></tr></thead>
            <tbody id="attendance-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="marks" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Marks</h2>
          <div class="flex items-center gap-2">
            <button class="btn btn-secondary btn-sm export-csv" data-type="marks">CSV</button>
            <button id="add-marks-btn" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Add Marks</button>
          </div>
        </div>

        <div class="card">
          <table class="data-table w-full">
            <thead><tr><th>Student</th><th>Subject</th><th>Marks</th><th class="actions-cell">Actions</th></tr></thead>
            <tbody id="marks-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="grades" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Grades</h2>
          <div class="flex items-center gap-2">
            <button class="btn btn-secondary btn-sm export-csv" data-type="grades">CSV</button>
            <button id="calculate-grades-btn" class="btn btn-primary btn-sm">Calculate</button>
            <button id="view-grades-btn" class="btn btn-secondary btn-sm">View</button>
          </div>
        </div>
        <div id="grades-table-container" class="card hide">
          <table class="data-table w-full">
            <thead><tr><th>Student</th><th>Average</th><th>Grade</th></tr></thead>
            <tbody id="grades-table-body"></tbody>
          </table>
        </div>
      </section>

      <section id="reports" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Reports — Attendance by Subject</h2>
          <div class="flex items-center gap-2">
            <select id="report-subject-select" class="form-input"></select>
            <button id="generate-report-btn" class="btn btn-primary btn-sm">Generate</button>
          </div>
        </div>

        <div id="report-result" class="card mt-3 hide">
          <h3 id="report-title" class="font-semibold text-lg"></h3>
          <div id="report-stats" class="mt-3"></div>
          <div id="report-list" class="mt-4"></div>
          <div class="mt-4">
            <button id="export-report-csv" class="btn btn-secondary btn-sm" data-type="report">Export CSV</button>
            <button id="export-report-pdf" class="btn btn-secondary btn-sm">Export PDF</button>
          </div>
        </div>
      </section>

      <!-- NEW NOTICES SECTION -->
      <section id="notices" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Notices & Circulars</h2>
          <button id="add-notice-btn" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Add Notice</button>
        </div>
        <div class="card">
          <table class="data-table w-full">
            <thead><tr><th>Date</th><th>Title</th><th class="actions-cell">Actions</th></tr></thead>
            <tbody id="notice-table-body"></tbody>
          </table>
        </div>
      </section>
      
      <section id="settings" class="content-section hide">
        <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Settings / User Management</h2>
          <div class="card">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-semibold text-xl">Users</h3>
              <div>
                <button id="add-user-btn" class="btn btn-primary btn-sm"><i class="fas fa-plus mr-1"></i>Add User</button>
              </div>
            </div>
            <table class="data-table w-full">
              <thead><tr><th>ID</th><th>Username</th><th>Role</th><th class="actions-cell">Actions</th></tr></thead>
              <tbody id="user-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>
      
    </main>
  </div>

  <!-- Modals -->
  <div id="student-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button class="close-btn" data-close>&times;</button>
      <h3 id="student-modal-title" class="font-semibold mb-2">Add Student</h3>
      <form id="student-form">
        <input type="hidden" id="student-doc-id">
        <div class="mb-3"><label class="text-sm">Name</label><input id="student-name" class="form-input mt-1" required /></div>
        <div class="mb-3"><label class="text-sm">Roll No.</label><input id="student-rollno" class="form-input mt-1" required /></div>
        <div class="mb-3"><label class="text-sm">Class</label><input id="student-class" class="form-input mt-1" required /></div>
        <div class="text-right"><button type="submit" class="btn btn-primary">Save</button></div>
      </form>
    </div>
  </div>

  <div id="faculty-modal" class="modal"><div class="modal-content">
    <button class="close-btn" data-close>&times;</button>
    <h3 id="faculty-modal-title" class="font-semibold mb-2">Add Faculty</h3>
    <form id="faculty-form">
      <input type="hidden" id="faculty-doc-id">
      <div class="mb-3"><label class="text-sm">Name</label><input id="faculty-name" class="form-input mt-1" required /></div>
      <div class="mb-3"><label class="text-sm">Department</label><input id="faculty-department" class="form-input mt-1" required /></div>
      <div class="text-right"><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div></div>

  <div id="subject-modal" class="modal"><div class="modal-content">
    <button class="close-btn" data-close>&times;</button>
    <h3 id="subject-modal-title" class="font-semibold mb-2">Add Subject</h3>
    <form id="subject-form">
      <input type="hidden" id="subject-doc-id">
      <div class="mb-3"><label class="text-sm">Code</label><input id="subject-code" class="form-input mt-1" required /></div>
      <div class="mb-3"><label class="text-sm">Name</label><input id="subject-name" class="form-input mt-1" required /></div>
      <div class="mb-3"><label class="text-sm">Faculty</label><input id="subject-faculty" class="form-input mt-1" required /></div>
      <div class="text-right"><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div></div>

  <div id="marks-modal" class="modal"><div class="modal-content">
    <button class="close-btn" data-close>&times;</button>
    <h3 id="marks-modal-title" class="font-semibold mb-2">Add Marks</h3>
    <form id="marks-form">
      <input type="hidden" id="marks-doc-id">
      <div class="mb-3"><label class="text-sm">Student</label><select id="marks-student" class="form-input mt-1" required></select></div>
      <div class="mb-3"><label class="text-sm">Subject</label><select id="marks-subject" class="form-input mt-1" required></select></div>
      <div class="mb-3"><label class="text-sm">Score</label><input id="marks-score" type="number" min="0" max="100" class="form-input mt-1" required /></div>
      <div class="text-right"><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div></div>
  
  <div id="notice-modal" class="modal"><div class="modal-content">
    <button class="close-btn" data-close>&times;</button>
    <h3 id="notice-modal-title" class="font-semibold mb-2">Add Notice</h3>
    <form id="notice-form">
      <input type="hidden" id="notice-doc-id">
      <div class="mb-3"><label class="text-sm">Title</label><input id="notice-title" class="form-input mt-1" required /></div>
      <div class="mb-3"><label class="text-sm">Content</label><textarea id="notice-content" class="form-input mt-1" rows="5" required></textarea></div>
      <div class="text-right"><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div></div>
  
  <div id="take-attendance-modal" class="modal">
    <div class="modal-content">
      <button class="close-btn" data-close>&times;</button>
      <h3 class="font-semibold mb-2">Take Attendance</h3>
      <div class="mb-3"><label class="text-sm">Subject</label><select id="attendance-subject" class="form-input mt-1"></select></div>
      <div id="attendance-list" class="space-y-2 mt-4"></div>
      <div class="mt-4 text-right"><button id="save-attendance-btn" class="btn btn-primary">Save Attendance</button></div>
    </div>
  </div>

  <div id="view-records-modal" class="modal">
      <div class="modal-content">
          <button class="close-btn" data-close>&times;</button>
          <h3 class="font-semibold mb-2">Attendance Records</h3>
          <div class="card">
              <table class="data-table w-full">
                  <thead><tr><th>Student</th><th>Subject</th><th>Date</th><th>Status</th></tr></thead>
                  <tbody id="attendance-records-body"></tbody>
              </table>
          </div>
      </div>
  </div>
  
  <div id="user-modal" class="modal"><div class="modal-content">
    <button class="close-btn" data-close>&times;</button>
    <h3 id="user-modal-title" class="font-semibold mb-2">Add User</h3>
    <form id="user-form">
      <input type="hidden" id="user-doc-id">
      <div class="mb-3"><label class="text-sm">Username</label><input id="user-username" class="form-input mt-1" required /></div>
      <div class="mb-3"><label class="text-sm">Password</label><input id="user-password" class="form-input mt-1" type="password" required /></div>
      <div class="mb-3"><label class="text-sm">Role</label><select id="user-role" class="form-input mt-1" required><option>admin</option><option>student</option><option>faculty</option></select></div>
      <div class="text-right"><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div></div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Utility function to get element by ID
    const getEl = (id) => document.getElementById(id);

    // Initial data and state
    let data = {
        students: [],
        faculty: [],
        subjects: [],
        attendance: [],
        marks: [],
        notices: [],
        users: [{ id: 'admin', username: 'admin', password: 'admin123', role: 'admin' }]
    };

    let currentUser = null;

    // Load data from localStorage
    const loadData = () => {
        try {
            const storedData = JSON.parse(localStorage.getItem('attendanceApp'));
            if (storedData) {
                // Merge to ensure new sections are included
                data = { ...data, ...storedData };
            }
        } catch (e) {
            console.error("Could not load data from localStorage", e);
        }
    };

    // Save data to localStorage
    const saveData = () => {
        localStorage.setItem('attendanceApp', JSON.stringify(data));
    };

    // Show a toast notification
    const showToast = (message) => {
        const toastEl = getEl('toast');
        toastEl.textContent = message;
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 3000);
    };

    // Login logic
    getEl('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = getEl('username').value;
        const password = getEl('password').value;

        const user = data.users.find(u => u.username === username && u.password === password);

        if (user) {
            currentUser = user;
            getEl('login-page').style.display = 'none';
            getEl('dashboard-main').style.display = 'flex';
            updateDashboardUI();
            updateNoticeCircular();
            showToast('Login successful!');
        } else {
            showToast('Invalid username or password.');
        }
    });

    // Logout logic
    getEl('logout-btn').addEventListener('click', () => {
        currentUser = null;
        getEl('dashboard-main').style.display = 'none';
        getEl('login-page').style.display = 'flex';
        showToast('Logged out successfully.');
    });

    // Sidebar navigation
    const navLinks = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.content-section');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.dataset.section;

            navLinks.forEach(nav => nav.classList.remove('active'));
            link.classList.add('active');

            sections.forEach(sec => sec.classList.add('hide'));
            getEl(sectionId).classList.remove('hide');
            
            // Re-render the correct section content
            switch(sectionId) {
                case 'dashboard': updateDashboardUI(); break;
                case 'students': renderStudentsTable(); break;
                case 'faculty': renderFacultyTable(); break;
                case 'subjects': renderSubjectsTable(); break;
                case 'attendance': getEl('attendance-table-container').classList.add('hide'); break;
                case 'marks': renderMarksTable(); break;
                case 'grades': getEl('grades-table-container').classList.add('hide'); break;
                case 'reports': populateReportSubjects(); getEl('report-result').classList.add('hide'); break;
                case 'notices': renderNoticesTable(); break;
                case 'settings': renderUsersTable(); break;
            }
            // Clear search bar on section change
            getEl('global-search').value = '';
        });
    });

    // Sidebar toggle for mobile
    getEl('sidebar-toggle').addEventListener('click', () => {
        const sidebar = getEl('sidebar');
        if (sidebar.style.display === 'none' || window.innerWidth > 900) {
            sidebar.style.display = 'block';
        } else {
            sidebar.style.display = 'none';
        }
    });

    // Render functions
    const renderStudentsTable = (filterText = '') => {
        const tableBody = getEl('student-table-body');
        tableBody.innerHTML = '';
        const filteredStudents = data.students.filter(s => 
            s.name.toLowerCase().includes(filterText.toLowerCase()) || 
            s.rollNo.includes(filterText) ||
            s.class.toLowerCase().includes(filterText.toLowerCase())
        );
        filteredStudents.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student.rollNo}</td>
                <td>${student.name}</td>
                <td>${student.class}</td>
                <td>
                    <button class="btn btn-sm btn-secondary edit-btn" data-type="student" data-id="${student.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-type="student" data-id="${student.id}">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };

    const renderFacultyTable = (filterText = '') => {
        const tableBody = getEl('faculty-table-body');
        tableBody.innerHTML = '';
        const filteredFaculty = data.faculty.filter(f => 
            f.name.toLowerCase().includes(filterText.toLowerCase()) ||
            f.department.toLowerCase().includes(filterText.toLowerCase())
        );
        filteredFaculty.forEach(faculty => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${faculty.id}</td>
                <td>${faculty.name}</td>
                <td>${faculty.department}</td>
                <td>
                    <button class="btn btn-sm btn-secondary edit-btn" data-type="faculty" data-id="${faculty.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-type="faculty" data-id="${faculty.id}">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };

    const renderSubjectsTable = (filterText = '') => {
        const tableBody = getEl('subject-table-body');
        tableBody.innerHTML = '';
        const filteredSubjects = data.subjects.filter(s => 
            s.code.toLowerCase().includes(filterText.toLowerCase()) ||
            s.name.toLowerCase().includes(filterText.toLowerCase()) ||
            s.faculty.toLowerCase().includes(filterText.toLowerCase())
        );
        filteredSubjects.forEach(subject => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${subject.code}</td>
                <td>${subject.name}</td>
                <td>${subject.faculty}</td>
                <td>
                    <button class="btn btn-sm btn-secondary edit-btn" data-type="subject" data-id="${subject.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-type="subject" data-id="${subject.id}">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };
    
    const renderMarksTable = (filterText = '') => {
        const tableBody = getEl('marks-table-body');
        tableBody.innerHTML = '';
        const filteredMarks = data.marks.filter(m => {
            const student = data.students.find(s => s.id === m.studentId);
            const subject = data.subjects.find(s => s.id === m.subjectId);
            const studentName = student ? student.name.toLowerCase() : '';
            const subjectName = subject ? subject.name.toLowerCase() : '';
            return studentName.includes(filterText.toLowerCase()) || subjectName.includes(filterText.toLowerCase());
        });
        
        filteredMarks.forEach(marks => {
            const student = data.students.find(s => s.id === marks.studentId);
            const subject = data.subjects.find(s => s.id === marks.subjectId);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student ? student.name : 'Unknown'}</td>
                <td>${subject ? subject.name : 'Unknown'}</td>
                <td>${marks.score}</td>
                <td>
                    <button class="btn btn-sm btn-secondary edit-btn" data-type="marks" data-id="${marks.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-type="marks" data-id="${marks.id}">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };
    
    const renderNoticesTable = (filterText = '') => {
        const tableBody = getEl('notice-table-body');
        tableBody.innerHTML = '';
        const filteredNotices = data.notices.filter(n =>
            n.title.toLowerCase().includes(filterText.toLowerCase()) ||
            n.content.toLowerCase().includes(filterText.toLowerCase()) ||
            n.date.toLowerCase().includes(filterText.toLowerCase())
        );

        filteredNotices.forEach(notice => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${notice.date}</td>
                <td>${notice.title}</td>
                <td>
                    <button class="btn btn-sm btn-secondary edit-btn" data-type="notice" data-id="${notice.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-type="notice" data-id="${notice.id}">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    };
    
    const renderUsersTable = (filterText = '') => {
        const tableBody = getEl('user-table-body');
        tableBody.innerHTML = '';
        const filteredUsers = data.users.filter(u =>
            u.username.toLowerCase().includes(filterText.toLowerCase()) ||
            u.role.toLowerCase().includes(filterText.toLowerCase())
        );

        filteredUsers.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.role}</td>
                <td>
                    ${user.id !== 'admin' ? 
                        `<button class="btn btn-sm btn-secondary edit-btn" data-type="user" data-id="${user.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="user" data-id="${user.id}">Delete</button>` 
                        : ''}
                </td>
            `;
            tableBody.appendChild(row);
        });
    };

    const updateDashboardUI = () => {
        if (!currentUser) return;
        getEl('user-display-name').textContent = currentUser.username;
        getEl('user-display-role').textContent = currentUser.role;
        getEl('role-badge').textContent = `Logged in as: ${currentUser.role}`;

        getEl('total-students').textContent = data.students.length;
        getEl('total-faculty').textContent = data.faculty.length;
        getEl('total-subjects').textContent = data.subjects.length;
    };

    // नया फंक्शन: सर्कुलर नोटिस को अपडेट करने के लिए
    const updateNoticeCircular = () => {
        const noticeCircular = getEl('notice-circular');
        const noticeText = noticeCircular.querySelector('.text');
        
        if (data.notices.length > 0) {
            const latestNotice = data.notices[data.notices.length - 1];
            noticeText.textContent = latestNotice.title + ' - ' + latestNotice.content;
            noticeCircular.classList.remove('hidden');
        } else {
            // अगर कोई नोटिस नहीं है, तो सर्कुलर को छुपा दें
            noticeCircular.classList.add('hidden');
        }
    };

    // Modal logic
    const modals = document.querySelectorAll('.modal');
    const openModal = (modalId) => {
        getEl(modalId).classList.add('active');
    };
    const closeModal = () => {
        modals.forEach(m => m.classList.remove('active'));
    };
    document.querySelectorAll('[data-close]').forEach(btn => {
        btn.addEventListener('click', closeModal);
    });

    // Form submission handlers
    getEl('student-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const studentId = getEl('student-doc-id').value;
        const student = {
            id: studentId || Date.now().toString(),
            name: getEl('student-name').value,
            rollNo: getEl('student-rollno').value,
            class: getEl('student-class').value,
        };
        if (studentId) {
            const index = data.students.findIndex(s => s.id === studentId);
            if (index !== -1) data.students[index] = student;
            showToast('Student updated!');
        } else {
            data.students.push(student);
            showToast('Student added!');
        }
        saveData();
        closeModal();
        renderStudentsTable();
        updateDashboardUI();
    });

    getEl('faculty-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const facultyId = getEl('faculty-doc-id').value;
        const faculty = {
            id: facultyId || Date.now().toString(),
            name: getEl('faculty-name').value,
            department: getEl('faculty-department').value
        };
        if (facultyId) {
            const index = data.faculty.findIndex(f => f.id === facultyId);
            if (index !== -1) data.faculty[index] = faculty;
            showToast('Faculty updated!');
        } else {
            data.faculty.push(faculty);
            showToast('Faculty added!');
        }
        saveData();
        closeModal();
        renderFacultyTable();
        updateDashboardUI();
    });

    getEl('subject-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const subjectId = getEl('subject-doc-id').value;
        const subject = {
            id: subjectId || Date.now().toString(),
            code: getEl('subject-code').value,
            name: getEl('subject-name').value,
            faculty: getEl('subject-faculty').value,
        };
        if (subjectId) {
            const index = data.subjects.findIndex(s => s.id === subjectId);
            if (index !== -1) data.subjects[index] = subject;
            showToast('Subject updated!');
        } else {
            data.subjects.push(subject);
            showToast('Subject added!');
        }
        saveData();
        closeModal();
        renderSubjectsTable();
        updateDashboardUI();
    });
    
    getEl('marks-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const marksId = getEl('marks-doc-id').value;
        const marks = {
            id: marksId || Date.now().toString(),
            studentId: getEl('marks-student').value,
            subjectId: getEl('marks-subject').value,
            score: parseInt(getEl('marks-score').value),
        };
        if (marksId) {
            const index = data.marks.findIndex(m => m.id === marksId);
            if (index !== -1) data.marks[index] = marks;
            showToast('Marks updated!');
        } else {
            data.marks.push(marks);
            showToast('Marks added!');
        }
        saveData();
        closeModal();
        renderMarksTable();
    });

    getEl('notice-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const noticeId = getEl('notice-doc-id').value;
        const notice = {
            id: noticeId || Date.now().toString(),
            date: new Date().toLocaleDateString(),
            title: getEl('notice-title').value,
            content: getEl('notice-content').value,
        };
        if (noticeId) {
            const index = data.notices.findIndex(n => n.id === noticeId);
            if (index !== -1) data.notices[index] = notice;
            showToast('Notice updated!');
        } else {
            data.notices.push(notice);
            showToast('Notice added!');
        }
        saveData();
        closeModal();
        renderNoticesTable();
        updateNoticeCircular(); // नया नोटिस जोड़ने पर सर्कुलर को अपडेट करें
    });
    
    getEl('user-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const userId = getEl('user-doc-id').value;
        const user = {
            id: userId || Date.now().toString(),
            username: getEl('user-username').value,
            password: getEl('user-password').value,
            role: getEl('user-role').value,
        };
        if (userId) {
            const index = data.users.findIndex(u => u.id === userId);
            if (index !== -1) data.users[index] = user;
            showToast('User updated!');
        } else {
            data.users.push(user);
            showToast('User added!');
        }
        saveData();
        closeModal();
        renderUsersTable();
    });

    // Add buttons logic
    getEl('add-student-btn').addEventListener('click', () => {
        getEl('student-modal-title').textContent = 'Add Student';
        getEl('student-form').reset();
        getEl('student-doc-id').value = '';
        openModal('student-modal');
    });

    getEl('add-faculty-btn').addEventListener('click', () => {
        getEl('faculty-modal-title').textContent = 'Add Faculty';
        getEl('faculty-form').reset();
        getEl('faculty-doc-id').value = '';
        openModal('faculty-modal');
    });

    getEl('add-subject-btn').addEventListener('click', () => {
        getEl('subject-modal-title').textContent = 'Add Subject';
        getEl('subject-form').reset();
        getEl('subject-doc-id').value = '';
        openModal('subject-modal');
    });
    
    getEl('add-marks-btn').addEventListener('click', () => {
        getEl('marks-modal-title').textContent = 'Add Marks';
        getEl('marks-form').reset();
        getEl('marks-doc-id').value = '';
        populateMarksDropdowns();
        openModal('marks-modal');
    });

    getEl('add-notice-btn').addEventListener('click', () => {
        getEl('notice-modal-title').textContent = 'Add Notice';
        getEl('notice-form').reset();
        getEl('notice-doc-id').value = '';
        openModal('notice-modal');
    });
    
    getEl('add-user-btn').addEventListener('click', () => {
        getEl('user-modal-title').textContent = 'Add User';
        getEl('user-form').reset();
        getEl('user-doc-id').value = '';
        openModal('user-modal');
    });

    // Edit/Delete button delegation
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const type = e.target.dataset.type;
            const id = e.target.dataset.id;
            let item;
            let modalId;
            let form;
            let docIdInput;

            switch(type) {
                case 'student':
                    item = data.students.find(s => s.id === id);
                    modalId = 'student-modal';
                    form = getEl('student-form');
                    docIdInput = getEl('student-doc-id');
                    getEl('student-modal-title').textContent = 'Edit Student';
                    getEl('student-name').value = item.name;
                    getEl('student-rollno').value = item.rollNo;
                    getEl('student-class').value = item.class;
                    break;
                case 'faculty':
                    item = data.faculty.find(f => f.id === id);
                    modalId = 'faculty-modal';
                    form = getEl('faculty-form');
                    docIdInput = getEl('faculty-doc-id');
                    getEl('faculty-modal-title').textContent = 'Edit Faculty';
                    getEl('faculty-name').value = item.name;
                    getEl('faculty-department').value = item.department;
                    break;
                case 'subject':
                    item = data.subjects.find(s => s.id === id);
                    modalId = 'subject-modal';
                    form = getEl('subject-form');
                    docIdInput = getEl('subject-doc-id');
                    getEl('subject-modal-title').textContent = 'Edit Subject';
                    getEl('subject-code').value = item.code;
                    getEl('subject-name').value = item.name;
                    getEl('subject-faculty').value = item.faculty;
                    break;
                case 'marks':
                    item = data.marks.find(m => m.id === id);
                    modalId = 'marks-modal';
                    form = getEl('marks-form');
                    docIdInput = getEl('marks-doc-id');
                    getEl('marks-modal-title').textContent = 'Edit Marks';
                    populateMarksDropdowns();
                    getEl('marks-student').value = item.studentId;
                    getEl('marks-subject').value = item.subjectId;
                    getEl('marks-score').value = item.score;
                    break;
                case 'notice':
                    item = data.notices.find(n => n.id === id);
                    modalId = 'notice-modal';
                    form = getEl('notice-form');
                    docIdInput = getEl('notice-doc-id');
                    getEl('notice-modal-title').textContent = 'Edit Notice';
                    getEl('notice-title').value = item.title;
                    getEl('notice-content').value = item.content;
                    break;
                case 'user':
                    item = data.users.find(u => u.id === id);
                    modalId = 'user-modal';
                    form = getEl('user-form');
                    docIdInput = getEl('user-doc-id');
                    getEl('user-modal-title').textContent = 'Edit User';
                    getEl('user-username').value = item.username;
                    getEl('user-password').value = item.password;
                    getEl('user-role').value = item.role;
                    break;
            }
            if (item) {
                docIdInput.value = item.id;
                openModal(modalId);
            }
        }
        if (e.target.classList.contains('delete-btn')) {
            const type = e.target.dataset.type;
            const id = e.target.dataset.id;
            // Use a custom alert/confirm box instead of the browser's native one for a better user experience
            const isConfirmed = window.confirm(`Are you sure you want to delete this ${type}?`);
            if (isConfirmed) {
                data[type + 's'] = data[type + 's'].filter(item => item.id !== id);
                saveData();
                showToast(`${type} deleted.`);
                updateDashboardUI();
                switch(type) {
                    case 'student': renderStudentsTable(); break;
                    case 'faculty': renderFacultyTable(); break;
                    case 'subject': renderSubjectsTable(); break;
                    case 'marks': renderMarksTable(); break;
                    case 'notice': 
                        renderNoticesTable();
                        updateNoticeCircular(); // नोटिस डिलीट होने पर सर्कुलर को अपडेट करें
                        break;
                    case 'user': renderUsersTable(); break;
                }
            }
        }
    });

    // Marks/Attendance Dropdown population
    const populateMarksDropdowns = () => {
        const studentSelect = getEl('marks-student');
        const subjectSelect = getEl('marks-subject');
        studentSelect.innerHTML = '';
        subjectSelect.innerHTML = '';
        data.students.forEach(s => studentSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
        data.subjects.forEach(s => subjectSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
    };

    const populateAttendanceDropdown = () => {
        const subjectSelect = getEl('attendance-subject');
        subjectSelect.innerHTML = '';
        data.subjects.forEach(s => subjectSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
    };

    // Take Attendance
    getEl('take-attendance-btn').addEventListener('click', () => {
        if (data.students.length === 0) {
            showToast('Please add students first.');
            return;
        }
        if (data.subjects.length === 0) {
            showToast('Please add subjects first.');
            return;
        }
        populateAttendanceDropdown();
        getEl('attendance-list').innerHTML = data.students.map(s => `
            <div class="flex items-center justify-between p-3 rounded-lg bg-gray-100">
                <span>${s.name}</span>
                <div class="flex items-center gap-2">
                    <button class="btn btn-sm btn-primary status-btn" data-status="present" data-student-id="${s.id}">Present</button>
                    <button class="btn btn-sm btn-danger status-btn" data-status="absent" data-student-id="${s.id}">Absent</button>
                </div>
            </div>
        `).join('');
        openModal('take-attendance-modal');
    });

    getEl('save-attendance-btn').addEventListener('click', () => {
        const subjectId = getEl('attendance-subject').value;
        const subjectName = data.subjects.find(s => s.id === subjectId).name;
        const currentDate = new Date().toLocaleDateString();
        const attendanceItems = document.querySelectorAll('#attendance-list > div');
        let newRecords = [];

        attendanceItems.forEach(item => {
            const studentId = item.querySelector('.status-btn').dataset.studentId;
            const presentBtn = item.querySelector('[data-status="present"].btn-primary');
            const status = presentBtn ? 'present' : 'absent';
            newRecords.push({
                id: Date.now().toString() + '-' + studentId,
                studentId: studentId,
                subjectId: subjectId,
                date: currentDate,
                status: status
            });
        });

        // Add new records to data, replacing old ones for the same subject/date
        data.attendance = data.attendance.filter(a => a.subjectId !== subjectId || a.date !== currentDate).concat(newRecords);
        saveData();
        showToast('Attendance saved successfully.');
        closeModal();
    });

    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('status-btn')) {
            const studentItem = e.target.closest('div');
            const allBtns = studentItem.querySelectorAll('.status-btn');
            allBtns.forEach(btn => btn.classList.remove('btn-primary', 'btn-danger'));
            e.target.classList.add(e.target.dataset.status === 'present' ? 'btn-primary' : 'btn-danger');
        }
    });

    getEl('view-attendance-btn').addEventListener('click', () => {
        const tableBody = getEl('attendance-records-body');
        tableBody.innerHTML = '';
        data.attendance.forEach(record => {
            const student = data.students.find(s => s.id === record.studentId);
            const subject = data.subjects.find(s => s.id === record.subjectId);
            if (student && subject) {
                const row = document.createElement('tr');
                const statusClass = record.status === 'present' ? 'status-present' : 'status-absent';
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${subject.name}</td>
                    <td>${record.date}</td>
                    <td><span class="${statusClass}">${record.status}</span></td>
                `;
                tableBody.appendChild(row);
            }
        });
        openModal('view-records-modal');
    });

    // Grades and Reports logic
    getEl('calculate-grades-btn').addEventListener('click', () => {
        const studentGrades = {};
        data.students.forEach(s => studentGrades[s.id] = { totalMarks: 0, count: 0 });

        data.marks.forEach(m => {
            if (studentGrades[m.studentId]) {
                studentGrades[m.studentId].totalMarks += m.score;
                studentGrades[m.studentId].count++;
            }
        });

        const gradesData = data.students.map(s => {
            const studentStats = studentGrades[s.id];
            const average = studentStats.count > 0 ? (studentStats.totalMarks / studentStats.count).toFixed(2) : 0;
            let grade = 'N/A';
            if (average >= 90) grade = 'A';
            else if (average >= 80) grade = 'B';
            else if (average >= 70) grade = 'C';
            else if (average >= 60) grade = 'D';
            else if (average > 0) grade = 'F';

            return { studentId: s.id, studentName: s.name, average, grade };
        });

        const tableBody = getEl('grades-table-body');
        tableBody.innerHTML = '';
        gradesData.forEach(g => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${g.studentName}</td><td>${g.average}</td><td>${g.grade}</td>`;
            tableBody.appendChild(row);
        });
        
        getEl('grades-table-container').classList.remove('hide');
        showToast('Grades calculated.');
    });

    getEl('view-grades-btn').addEventListener('click', () => {
        getEl('grades-table-container').classList.remove('hide');
        showToast('Viewing grades.');
    });

    // Report Generation
    const populateReportSubjects = () => {
        const subjectSelect = getEl('report-subject-select');
        subjectSelect.innerHTML = data.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    };

    getEl('generate-report-btn').addEventListener('click', () => {
        const subjectId = getEl('report-subject-select').value;
        const subject = data.subjects.find(s => s.id === subjectId);
        if (!subject) {
            showToast('Please select a subject.');
            getEl('report-result').classList.add('hide');
            return;
        }

        const attendanceRecords = data.attendance.filter(a => a.subjectId === subjectId);
        const totalClasses = [...new Set(attendanceRecords.map(a => a.date))].length; // Count unique dates
        const attendanceMap = {};

        data.students.forEach(s => attendanceMap[s.id] = { present: 0, absent: 0 });
        attendanceRecords.forEach(a => {
            if (attendanceMap[a.studentId]) {
                attendanceMap[a.studentId][a.status]++;
            }
        });

        const reportList = getEl('report-list');
        reportList.innerHTML = '';
        let presentCount = 0, absentCount = 0;

        data.students.forEach(s => {
            const studentStats = attendanceMap[s.id] || { present: 0, absent: 0 };
            presentCount += studentStats.present;
            absentCount += studentStats.absent;
            const attendancePercentage = totalClasses > 0 ? ((studentStats.present / totalClasses) * 100).toFixed(2) : 0;
            const listItem = document.createElement('div');
            listItem.className = 'p-3 my-2 rounded-lg bg-gray-100 flex justify-between items-center';
            listItem.innerHTML = `
                <span>${s.name} (${s.rollNo})</span>
                <span>
                    <span class="text-sm">Present: ${studentStats.present}, Absent: ${studentStats.absent}</span> 
                    <strong class="ml-2">${attendancePercentage}%</strong>
                </span>
            `;
            reportList.appendChild(listItem);
        });

        const totalStudents = data.students.length;
        const avgAttendance = totalClasses > 0 && totalStudents > 0 ? ((presentCount / (totalStudents * totalClasses)) * 100).toFixed(2) : 0;
        
        getEl('report-title').textContent = `Attendance Report for ${subject.name}`;
        getEl('report-stats').innerHTML = `
            <p>Total Classes: <strong>${totalClasses}</strong></p>
            <p>Total Students: <strong>${totalStudents}</strong></p>
            <p>Average Attendance: <strong>${avgAttendance}%</strong></p>
        `;
        getEl('report-result').classList.remove('hide');
        showToast('Report generated.');
    });

    // CSV/PDF Export functionality (delegation)
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('export-csv')) {
            const type = e.target.dataset.type;
            let exportData = [];
            let filename = '';

            if (type === 'report') {
                const subjectId = getEl('report-subject-select').value;
                const subjectName = data.subjects.find(s => s.id === subjectId)?.name || 'report';
                filename = `${subjectName}_attendance_report.csv`;
                const attendanceRecords = data.attendance.filter(a => a.subjectId === subjectId);
                const totalClasses = [...new Set(attendanceRecords.map(a => a.date))].length;
                const attendanceMap = {};
                data.students.forEach(s => attendanceMap[s.id] = { present: 0, absent: 0 });
                attendanceRecords.forEach(a => {
                    if (attendanceMap[a.studentId]) attendanceMap[a.studentId][a.status]++;
                });
                
                exportData.push(['Student Name', 'Roll No', 'Present', 'Absent', 'Percentage']);
                data.students.forEach(s => {
                    const studentStats = attendanceMap[s.id] || { present: 0, absent: 0 };
                    const attendancePercentage = totalClasses > 0 ? ((studentStats.present / totalClasses) * 100).toFixed(2) : 0;
                    exportData.push([s.name, s.rollNo, studentStats.present, studentStats.absent, attendancePercentage + '%']);
                });
            } else {
                let dataToExport = data[type];
                let headers = [];
                let mapFn = item => [];

                switch(type) {
                    case 'students':
                        headers = ['id', 'name', 'rollNo', 'class'];
                        mapFn = s => [s.id, s.name, s.rollNo, s.class];
                        break;
                    case 'faculty':
                        headers = ['id', 'name', 'department'];
                        mapFn = f => [f.id, f.name, f.department];
                        break;
                    case 'subjects':
                        headers = ['id', 'code', 'name', 'faculty'];
                        mapFn = s => [s.id, s.code, s.name, s.faculty];
                        break;
                    case 'attendance':
                        headers = ['id', 'studentName', 'subjectName', 'date', 'status'];
                        mapFn = a => {
                            const student = data.students.find(s => s.id === a.studentId);
                            const subject = data.subjects.find(s => s.id === a.subjectId);
                            return [a.id, student ? student.name : 'Unknown', subject ? subject.name : 'Unknown', a.date, a.status];
                        };
                        break;
                    case 'marks':
                        headers = ['id', 'studentName', 'subjectName', 'score'];
                        mapFn = m => {
                            const student = data.students.find(s => s.id === m.studentId);
                            const subject = data.subjects.find(s => s.id === m.subjectId);
                            return [m.id, student ? student.name : 'Unknown', subject ? subject.name : 'Unknown', m.score];
                        };
                        break;
                    case 'grades':
                        const gradesData = data.students.map(s => {
                            const studentMarks = data.marks.filter(m => m.studentId === s.id);
                            const totalMarks = studentMarks.reduce((sum, m) => sum + m.score, 0);
                            const average = studentMarks.length > 0 ? (totalMarks / studentMarks.length).toFixed(2) : 0;
                            let grade = 'N/A';
                            if (average >= 90) grade = 'A';
                            else if (average >= 80) grade = 'B';
                            else if (average >= 70) grade = 'C';
                            else if (average >= 60) grade = 'D';
                            else if (average > 0) grade = 'F';
                            return { studentName: s.name, average, grade };
                        });
                        exportData = [['Student Name', 'Average Score', 'Grade']];
                        gradesData.forEach(g => exportData.push([g.studentName, g.average, g.grade]));
                        filename = 'grades.csv';
                        break;
                    case 'notices':
                        headers = ['id', 'date', 'title', 'content'];
                        mapFn = n => [n.id, n.date, n.title, n.content];
                        break;
                    default:
                        showToast('Invalid export type.');
                        return;
                }

                if (type !== 'grades') {
                    exportData.push(headers);
                    dataToExport.forEach(item => exportData.push(mapFn(item)));
                    filename = `${type}.csv`;
                }
            }
            
            const csvContent = exportData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Exported to CSV.');
        }
    });

    getEl('export-report-pdf').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const element = document.getElementById('report-result');
      const title = getEl('report-title').textContent || 'Attendance Report';
      
      html2canvas(element).then(canvas => {
        const img = canvas.toDataURL('image/png');
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgWidth = pageWidth - 20; 
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        doc.text(title, 10, 10);
        doc.addImage(img, 'PNG', 10, 20, imgWidth, imgHeight);
        doc.save(`${title.replace(/\s+/g, '_')}.pdf`);
        showToast('Exported to PDF.');
      });
    });

    // Global search functionality
    getEl('global-search').addEventListener('input', (e) => {
        const filterText = e.target.value;
        const activeSection = document.querySelector('.content-section:not(.hide)');
        if (activeSection) {
            const sectionId = activeSection.id;
            switch(sectionId) {
                case 'students': renderStudentsTable(filterText); break;
                case 'faculty': renderFacultyTable(filterText); break;
                case 'subjects': renderSubjectsTable(filterText); break;
                case 'marks': renderMarksTable(filterText); break;
                case 'notices': renderNoticesTable(filterText); break;
                case 'settings': renderUsersTable(filterText); break;
            }
        }
    });

    // Initial render
    window.onload = () => {
      loadData();
      updateDashboardUI();
      updateNoticeCircular(); // पेज लोड होने पर सर्कुलर को अपडेट करें
      populateReportSubjects();
      
      // Initially show dashboard section if user is logged in
      if (currentUser) {
        document.querySelector('.content-section').classList.remove('hide');
        getEl('dashboard-main').style.display = 'flex';
        getEl('login-page').style.display = 'none';
      }
    };
  </script>
</body>
</html>
